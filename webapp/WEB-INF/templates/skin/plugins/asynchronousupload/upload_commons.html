<#--
 # The main macro is addFileInputAndfilesBox. The macro addRequiredJsFiles is used to include required JavaScript and CSS files.
 # Others macros are private.
 -->

<#--
 # Add required CSS and JavaScript files to use asynchronous uploads.
 # This is only needed in Back Office or in FO page not served by the portal service.
 -->
<#macro addRequiredJsFiles>
	<link rel="stylesheet" href="css/plugins/asynchronousupload/jquery.fileupload.css" />
	<link rel="stylesheet" href="css/plugins/asynchronousupload/jquery.fileupload-ui.css" />

	<script type="text/javascript" src="js/plugins/asynchronousupload/vendor/jquery.ui.widget.js" ></script>
	<script type="text/javascript" src="js/plugins/asynchronousupload/jquery.iframe-transport.js" ></script>
	<script type="text/javascript" src="js/plugins/asynchronousupload/jquery.fileupload.js" ></script>
	<script type="text/javascript" src="js/plugins/asynchronousupload/jquery.fileupload-process.js" ></script>
	<script type="text/javascript" src="js/plugins/asynchronousupload/jquery.fileupload-validate.js" ></script>
</#macro>


<#macro addFileInput fieldName handler cssClass='' multiple=false>
	<span class="">
		<input type="file" name="${fieldName}" id="${fieldName}" <#if multiple>multiple="multiple"</#if> class="${cssClass!} ${handler.handlerName}" />
		<button class="btn btn-primary btn-small" name="${handler.uploadSubmitPrefix}${fieldName}" id="${handler.uploadSubmitPrefix}${fieldName}" value="${handler.uploadSubmitPrefix}${fieldName}" type="submit" >
			#i18n{asynchronousupload.action.send.name}
		</button>
	</span>
	<input type="hidden" name="asynchronousupload.handler" value="${handler.handlerName}" />
	<div id="progress_${fieldName}" class="progress progress-striped progress-success" style="display: none;">
        <div id="progress-bar_${fieldName}" class="bar progress-bar progress-bar-success">&nbsp;</div>
    </div>
</#macro>

<#macro addUploadedFilesBox fieldName handler listFiles >
	<#-- file removing -->
	<#assign has_files = false>
	<#if listFiles?? && listFiles?has_content>
		<#assign has_files = true>
	</#if>
	
	<div id="_file_error_box_${fieldName}" >
	</div>
	
	<div class="control-group well" <#if !has_files>style="display:none;"</#if> id="_file_deletion_label_${fieldName}">
		<label class="control-label">#i18n{asynchronousupload.file.uploadedFile}</label>
		<div id="_file_deletion_${fieldName}">
			<#assign file_index = 0>
			<#if has_files>
				<#assign index = 0 />
				<#list listFiles as file>
					<#assign filename = ''>
					<#if file.name?? && file.name != ''>
						<#assign filename = file.name >
					<#else>
						<#if file.title?? && file.title != ''>
							<#assign filename = file.title >
						</#if>
					</#if>
					<#if filename != '' >
						<div class="controls" id="_file_uploaded_${fieldName}${file_index}">
							<label class="checkbox" for="${handler.uploadCheckboxPrefix}${fieldName}${file_index}">
							<input type="checkbox" name="${handler.uploadCheckboxPrefix}${fieldName}${file_index}" value="1" />${filename}</label>
							<#assign file_index = file_index + 1>
						</div>
					</#if>
				</#list>
			</#if>
		</div>
		<br />
		<div class="controls">
			<button class="btn btn-primary btn-small" name="${handler.uploadDeletePrefix}${fieldName}" value="${handler.uploadDeletePrefix}${fieldName}" type="submit" >#i18n{asynchronousupload.action.delete.name}</button>
		</div>
	</div>
</#macro>

<#-- Macro to add a file input for asynchronous and synchronous uploads.
 # @param fieldName The name of the field.
 # @param handler The associated handler service.
 # @param listUploadedFiles The list of files that have already been uploaded. Files must have a 'title' or a 'name' attribute. 
 # @param inputCssClass The CSS class to add to the input if any. Default value is an empty string.
 # @param multiple True to use an HTML5 multiple file input, false otherwise. Default value if false.
 -->
<#macro addFileInputAndfilesBox fieldName handler listUploadedFiles inputCssClass='' multiple=false>
	<@addFileInput fieldName=fieldName handler=handler cssClass=inputCssClass multiple=multiple />
	<@addUploadedFilesBox fieldName=fieldName handler=handler listFiles=listUploadedFiles />
</#macro>